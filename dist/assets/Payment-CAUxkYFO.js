var y=(v,c,d)=>new Promise((m,g)=>{var s=x=>{try{r(d.next(x))}catch(u){g(u)}},N=x=>{try{r(d.throw(x))}catch(u){g(u)}},r=x=>x.done?m(x.value):Promise.resolve(x.value).then(s,N);r((d=d.apply(v,c)).next())});import{c as te,j as e,A as k,C as se,_ as re}from"./index-DvcXioQz.js";import{f as ae,e as ne,r as a}from"./react-vendor-M-FLgoaJ.js";import{supabase as W,checkPaymentStatus as ie,getCheckoutSession as le,getPaymentBySessionId as ce,getWalletAddress as oe,getCryptoAmount as de,getIp as me,createPayment as xe,cancelPayment as ue}from"./supabase-BUJL_r64.js";import{L as j}from"./loader-2-C5iu4yIE.js";import{S as ye}from"./shield-check-Cc6ydtyS.js";import{C as pe}from"./check-circle-CP2xFwQD.js";import"./supabase-CxI1Zui4.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=te("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]),A=30*60,Ce=()=>{var V,J;const[v]=ae(),c=v.get("session_id"),d=ne(),[m,g]=a.useState("loading"),[s,N]=a.useState(null),[r,x]=a.useState(null),[u,P]=a.useState(""),[S,_]=a.useState(0),[I,Y]=a.useState(""),[T,E]=a.useState(A),[C,R]=a.useState(null),[h,b]=a.useState("pending"),[$,q]=a.useState(!1),[L,O]=a.useState(!1),[U,Q]=a.useState(null),[B,D]=a.useState(!1),p=a.useRef(null),F=a.useRef(!1),M=n=>y(void 0,null,function*(){try{const l=yield(yield re(()=>y(void 0,null,function*(){const{default:f}=yield import("./browser-C4fn0qDA.js").then(i=>i.b);return{default:f}}),[])).default.toDataURL(n,{errorCorrectionLevel:"H",margin:1,width:320,color:{dark:"#000000",light:"#ffffff"}});Y(l)}catch(t){}});a.useEffect(()=>{if(!c){d("/");return}return F.current?void 0:(F.current=!0,y(void 0,null,function*(){try{const t=yield le(c);if(!t)throw new Error("Invalid Session");N(t);const l=`ynv_pay_${c}`,f=localStorage.getItem(l);let i=null;if(f){const o=JSON.parse(f);o.expiry>Date.now()&&(i=o)}if(!i){const o=yield ce(c);if(o&&!["cancelled","timed_out"].includes(o.status)){const K=new Date(o.created_at).getTime()+A*1e3;K>Date.now()&&(i={id:o.id,walletAddress:o.wallet_address,cryptoAmount:o.required_crypto_amount,expiry:K,status:o.status},localStorage.setItem(l,JSON.stringify(i)))}}if(i)x({id:i.id}),P(i.walletAddress),_(i.cryptoAmount),R(i.expiry),b(i.status),yield M(i.walletAddress),g("payment");else{const[o,z]=yield Promise.all([oe(t.crypto),de(t.crypto,t.total)]);P(o.address),_(z.requiredCryptoAmount),g("confirmation")}}catch(t){d("/")}}),()=>{p.current&&clearInterval(p.current)})},[c,d]),a.useEffect(()=>{if(m==="payment"&&C){const n=()=>{const t=Date.now(),l=Math.floor((C-t)/1e3);l<=0?(E(0),b("timed_out"),p.current&&clearInterval(p.current)):E(l)};n(),p.current=setInterval(n,1e3)}return()=>{p.current&&clearInterval(p.current)}},[m,C]),a.useEffect(()=>{if(m==="payment"&&(r!=null&&r.id)){const n=W.channel(`pay_${r.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"payment",filter:`id=eq.${r.id}`},t=>{const l=t.new.status;b(l),t.new.crypto_difference&&Q(t.new.crypto_difference),["exact_match","overpaid"].includes(l)&&(localStorage.removeItem(`ynv_pay_${c}`),setTimeout(()=>d("/thank-you"),2e3))}).subscribe();return()=>{W.removeChannel(n)}}},[m,r,d,c]),a.useEffect(()=>{let n;return m==="payment"&&(r!=null&&r.id)&&!["exact_match","overpaid","cancelled","timed_out"].includes(h)&&(n=setInterval(()=>y(void 0,null,function*(){const t=yield ie(r.id);t&&(t.paymentStatus&&t.paymentStatus!==h&&b(t.paymentStatus),t.paymentStatus==="underpaid"&&t.cryptoDifference&&Q(t.cryptoDifference),t.requiredCryptoAmount&&_(t.requiredCryptoAmount))}),4e3)),()=>clearInterval(n)},[m,r,h]);const H=()=>y(void 0,null,function*(){O(!0);try{const t=Date.now()+A*1e3,l=yield me(),f=yield xe({session_id:c,email:s.email,product:s.product,price:s.total,crypto:s.crypto,wallet_address:u,status:"pending",required_crypto_amount:S,ip_address:l,user_agent:navigator.userAgent});yield M(u);const i={id:f.id,walletAddress:u,cryptoAmount:S,expiry:t,status:"pending"};localStorage.setItem(`ynv_pay_${c}`,JSON.stringify(i)),x(f),R(t),g("payment")}catch(n){}finally{O(!1)}}),G=()=>y(void 0,null,function*(){D(!0)}),X=()=>y(void 0,null,function*(){r!=null&&r.id&&(yield ue(r.id)),localStorage.removeItem(`ynv_pay_${c}`),d("/")}),Z=()=>{navigator.clipboard.writeText(u),q(!0),setTimeout(()=>q(!1),2e3)},ee=n=>{if(n<0)return"00:00";const t=Math.floor(n/60).toString().padStart(2,"0"),l=(n%60).toString().padStart(2,"0");return`${t}:${l}`},w=(()=>{switch(h){case"pending":return{color:"text-blue-300",bg:"bg-gray-900 border-gray-700",icon:e.jsx(j,{className:"w-4 h-4 animate-spin"}),text:"Monitoring blockchain..."};case"detected":return{color:"text-yellow-300",bg:"bg-yellow-900/20 border-yellow-700",icon:e.jsx(j,{className:"w-4 h-4 animate-spin"}),text:"Payment detected..."};case"exact_match":case"overpaid":return{color:"text-green-300",bg:"bg-green-900/20 border-green-700",icon:e.jsx(pe,{className:"w-4 h-4"}),text:"Payment Confirmed!"};case"underpaid":return{color:"text-red-300",bg:"bg-red-900/20 border-red-700",icon:e.jsx(k,{className:"w-4 h-4"}),text:"Underpaid!"};case"timed_out":return{color:"text-red-300",bg:"bg-red-900/20 border-red-700",icon:e.jsx(se,{className:"w-4 h-4"}),text:"Expired"};default:return{color:"text-gray-300",bg:"bg-gray-900",icon:e.jsx(k,{className:"w-4 h-4"}),text:"Unknown"}}})();return m==="loading"?e.jsx("div",{className:"w-full flex-grow flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md bg-[#0a0a0a] rounded-3xl border border-gray-800 shadow-[0_0_50px_rgba(0,0,0,0.5)] overflow-hidden relative",children:[e.jsx("div",{className:"h-1 bg-gradient-to-r from-gray-800 via-gray-700 to-gray-800 animate-pulse"}),e.jsxs("div",{className:"p-8 relative",children:[e.jsxs("div",{className:"text-center mb-8 space-y-3",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-900 rounded-lg mx-auto shimmer opacity-50"}),e.jsx("div",{className:"h-4 w-32 bg-gray-900 rounded-lg mx-auto shimmer opacity-30"})]}),e.jsxs("div",{className:"bg-gray-900/40 rounded-2xl p-6 border border-gray-800 space-y-4 mb-8",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"h-4 w-16 bg-gray-800 rounded shimmer opacity-40"}),e.jsx("div",{className:"h-5 w-32 bg-gray-800 rounded shimmer opacity-40"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"h-4 w-12 bg-gray-800 rounded shimmer opacity-40"}),e.jsx("div",{className:"h-4 w-40 bg-gray-800 rounded shimmer opacity-40"})]}),e.jsx("div",{className:"h-px bg-gray-800 my-2"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"h-4 w-24 bg-gray-800 rounded shimmer opacity-40"}),e.jsx("div",{className:"h-7 w-16 bg-gray-800 rounded-lg shimmer opacity-40"})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2",children:[e.jsx("div",{className:"h-5 w-20 bg-gray-800 rounded shimmer opacity-50"}),e.jsx("div",{className:"h-8 w-24 bg-gray-800 rounded shimmer opacity-50"})]})]}),e.jsx("div",{className:"w-full h-14 bg-gray-800 rounded-xl shimmer opacity-40"}),e.jsx("div",{className:"mt-6 flex justify-center",children:e.jsx("div",{className:"h-3 w-40 bg-gray-900 rounded shimmer opacity-30"})})]})]})}):m==="confirmation"?e.jsx("div",{className:"w-full flex-grow flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md bg-[#0a0a0a] rounded-3xl border border-gray-800 shadow-[0_0_50px_rgba(0,0,0,0.5)] overflow-hidden relative animate-fade-in",children:[e.jsx("div",{className:"h-1 bg-gradient-to-r from-purple-500 via-indigo-500 to-purple-500"}),e.jsxs("div",{className:"p-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h2",{className:"text-3xl font-bold text-white font-display mb-2",children:"Order Summary"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Review your purchase details below"})]}),e.jsxs("div",{className:"bg-gray-900/40 rounded-2xl p-6 border border-gray-800 space-y-4 mb-8 backdrop-blur-sm",children:[e.jsxs("div",{className:"flex justify-between items-center group",children:[e.jsx("span",{className:"text-gray-500 text-sm font-medium",children:"Product"}),e.jsx("span",{className:"text-white font-semibold text-right group-hover:text-purple-400 transition-colors",children:s.product})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-500 text-sm font-medium",children:"Email"}),e.jsx("span",{className:"text-white text-sm text-right font-mono text-gray-300",children:s.email})]}),e.jsx("div",{className:"h-px bg-gray-800 my-2"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-500 text-sm font-medium",children:"Payment Method"}),e.jsx("div",{className:"flex items-center text-white font-bold bg-gray-800 px-3 py-1 rounded-lg border border-gray-700",children:s.crypto})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2",children:[e.jsx("span",{className:"text-gray-400 text-base font-medium",children:"Total Price"}),e.jsxs("span",{className:"text-2xl font-bold text-white font-display text-green-400",children:["$",s.total.toFixed(2)]})]})]}),e.jsx("button",{onClick:H,disabled:L,className:"w-full bg-white hover:bg-gray-200 text-black font-extrabold py-4 rounded-xl shadow-xl transform active:scale-[0.98] transition-all flex items-center justify-center group",children:L?e.jsx(j,{className:"w-5 h-5 animate-spin"}):e.jsxs(e.Fragment,{children:["Confirm & Pay ",e.jsx(fe,{className:"w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform"})]})}),e.jsxs("div",{className:"mt-6 flex items-center justify-center text-[10px] text-gray-500 uppercase tracking-widest font-bold",children:[e.jsx(ye,{className:"w-3 h-3 mr-1.5 text-green-500"}),"Secure Encrypted Transaction"]})]})]})}):e.jsx("div",{className:"w-full flex-grow flex items-center justify-center bg-black p-4",children:e.jsxs("div",{className:"w-full max-w-lg bg-gray-800 text-white p-6 rounded-2xl shadow-2xl space-y-4 border border-gray-700 animate-fade-in relative overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-center border-b border-gray-700 pb-3",children:[e.jsx("h2",{className:"text-xl font-bold text-white font-display",children:"Send Payment"}),e.jsx("span",{className:`tabular-nums font-bold font-mono ${T<300?"text-red-500 animate-pulse":"text-red-400"}`,children:ee(T)})]}),e.jsx("p",{className:"text-sm text-gray-300 text-center",children:"Scan the QR or copy address to complete payment."}),e.jsx("div",{className:"flex justify-center py-2",children:e.jsxs("div",{className:"bg-white p-3 rounded-3xl relative",children:[I?e.jsx("img",{src:I,alt:"QR Code",className:"w-48 h-48 mix-blend-multiply"}):e.jsx("div",{className:"w-48 h-48 flex items-center justify-center text-black/20",children:e.jsx(j,{className:"w-8 h-8 animate-spin text-black"})}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg border-2 border-white",children:e.jsx("span",{className:"text-black font-bold text-xs",children:(V=s==null?void 0:s.crypto)==null?void 0:V.slice(0,3)})})})]})}),e.jsxs("div",{className:"bg-gray-900 p-4 rounded-xl space-y-4 border border-gray-700",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold mb-1",children:"Crypto Address"}),e.jsxs("div",{className:"flex items-center gap-2 font-mono text-sm bg-gray-800 p-2 rounded-xl border border-gray-700 group hover:border-gray-600 transition-colors",children:[e.jsx("span",{className:"break-all mr-1 text-gray-200 flex-1",children:u}),e.jsx("button",{onClick:Z,className:`px-3 py-1.5 rounded-lg text-xs font-bold transition-colors shrink-0 ${$?"bg-green-600 text-white":"bg-gray-700 hover:bg-gray-600 text-gray-200"}`,children:$?"Copied!":"Copy"})]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-xs text-gray-400 uppercase font-bold mb-1",children:["Amount (",s==null?void 0:s.crypto,")"]}),e.jsx("div",{className:"font-mono text-green-400 font-bold text-lg flex items-center",children:S.toFixed(8)}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Equivalent to: $",(J=s==null?void 0:s.total)==null?void 0:J.toFixed(2)," USD"]})]})]}),e.jsxs("div",{className:`w-full text-center p-3 rounded-xl text-sm font-medium flex justify-center items-center space-x-2 border transition-colors ${w.bg} ${w.color}`,children:[w.icon,e.jsx("span",{children:w.text})]}),h==="underpaid"&&U&&e.jsxs("div",{className:"bg-red-900/20 border border-red-600/50 p-3 rounded-xl text-center",children:[e.jsxs("p",{className:"text-red-300 text-sm font-bold",children:["You are short by: ",U.toFixed(8)," ",s==null?void 0:s.crypto]}),e.jsx("p",{className:"text-xs text-red-400 mt-1",children:"Please contact support immediately."})]}),e.jsx("button",{onClick:G,className:"w-full text-center text-sm text-gray-500 hover:text-gray-300 hover:underline py-2 transition-colors",children:"Cancel Payment"}),B&&e.jsx("div",{className:"absolute inset-0 bg-black/95 backdrop-blur-sm z-50 flex items-center justify-center p-6 animate-fade-in",children:e.jsxs("div",{className:"text-center space-y-4 max-w-xs w-full",children:[e.jsx("div",{className:"w-16 h-16 bg-red-900/20 rounded-full flex items-center justify-center mx-auto border border-red-500/30",children:e.jsx(k,{className:"w-8 h-8 text-red-500"})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Cancel Payment?"}),e.jsx("p",{className:"text-sm text-gray-400 leading-relaxed",children:"This specific wallet address is reserved for your order. Cancelling will discard it."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-4",children:[e.jsx("button",{onClick:()=>D(!1),className:"bg-gray-800 hover:bg-gray-700 text-white font-bold py-2.5 rounded-xl transition-colors text-sm",children:"Keep it"}),e.jsx("button",{onClick:X,className:"bg-red-600 hover:bg-red-500 text-white font-bold py-2.5 rounded-xl transition-colors text-sm",children:"Yes, Cancel"})]})]})})]})})};export{Ce as default};
